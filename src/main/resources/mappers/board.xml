<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.gma.gmagame.mapper.BoardMapper">
<!--    상위 10개 인기글 검색-->
    <select id="selectBest" resultType="com.gma.gmagame.model.Board">
        SELECT *
        FROM board_aaa
        WHERE <![CDATA[ROWNUM<=10]]>
        order by likes desc
    </select>
<!--    게시글 개수 검색 -->
    <select id="countBoard" resultType="int">
        SELECT COUNT(*) FROM board_aaa
        <include refid="search" />
    </select>
    <!-- 중간에 삭제된거 밀리지않게 게시글 조회 -->
    <select id="selectBoard" resultType="com.gma.gmagame.model.Board">
        SELECT board_idx,title,contents,hit_cnt,created_datetime,creator_id,LIKEs
        FROM ( SELECT ROWNUM RN, A.*
        FROM ( SELECT * FROM board_aaa
        <include refid="search" />
        ORDER BY board_idx asc ) A )
        WHERE RN BETWEEN #{start} AND #{end}
    </select>

    <select id="count" resultType="int">
        select count(*) from board_aaa
    </select>

    <!--  전체 게시글 조회-->
    <select id="selectAll" resultType="com.gma.gmagame.model.Board">
        SELECT *
        FROM board_aaa
        order by board_idx desc
    </select>

    <!--상세 게시글 조회-->
    <select id="selectOne" resultType="com.gma.gmagame.model.Board">
        SELECT *
        FROM board_aaa
        WHERE board_idx=#{user_idx}
    </select>
    <select id="selectBoardFileList" resultType="com.gma.gmagame.model.BoardFile">
			SELECT *
			FROM
				t_file
			WHERE
				board_idx = #{boardIdx}
    </select>
    <select id="selectBoardFileInformation" parameterType="map" resultType="com.gma.gmagame.model.BoardFile">
			SELECT*
			FROM
				t_file
			WHERE
				idx = #{idx} AND board_idx = #{boardIdx}
    </select>
<!--    조회수 증가-->
    <update id="updateViewCnt" parameterType="com.gma.gmagame.model.Board">
        UPDATE board_aaa
        SET hit_cnt = hit_cnt+1
        WHERE board_idx=#{user_idx}
    </update>
<!-- 게시글 작성-->
    <insert id="insertOne" parameterType="com.gma.gmagame.model.Board">
        <selectKey resultType="Integer" keyProperty="user_idx" order="BEFORE">
            SELECT NVL(MAX(board_idx),0)+1
            FROM board_aaa
        </selectKey>
        INSERT INTO board_aaa (board_idx,title,contents,HIT_CNT,created_datetime,creator_id,likes)
        VALUES(#{user_idx},#{title},#{contents},0,SYSDATE,#{name},0)
    </insert>
    <insert id="insertBoardFileList" parameterType="com.gma.gmagame.model.BoardFile">
        <selectKey resultType="Integer" keyProperty="Idx" order="BEFORE">
            SELECT NVL(MAX(Idx),0)+1
            FROM T_FILE
        </selectKey>
        <![CDATA[INSERT INTO t_file
			(   Idx,
				board_idx,
				original_file_name,
				stored_file_path,
				file_size,
				creator_id
			)VALUES]]>
        <foreach collection="list" item="item" separator=",">
            (
            2,
            #{item.boardIdx},
            #{item.originalFileName},
            #{item.storedFilePath},
            #{item.fileSize},
            'admin'
            )
        </foreach>
    </insert>
<!--게시글 삭제-->
    <delete id="deleteOne" parameterType="com.gma.gmagame.model.Board">
        DELETE
        FROM board_aaa
        WHERE board_idx=#{user_idx}
    </delete>
<!--게시글 수정-->
    <update id="updateOne" parameterType="com.gma.gmagame.model.Board">
        UPDATE board_aaa
        SET title =#{title},contents=#{contents}
        WHERE board_idx=#{user_idx}
    </update>
<!--검색된 게시글의 수 조회-->
    <select id="searchCountBoard" resultType="int">
        SELECT COUNT(*) FROM board_aaa
        WHERE title LIKE '%' ||#{keyword}||'%'
    </select>
<!--검색기능 키워드-->
    <sql id="search">
        <if test="keyword != null and keyword != ''">
            WHERE title LIKE '%' ||#{keyword}||'%'
        </if>
    </sql>

</mapper>