<!doctype html>
<html xmlns:th="http://www.thymmeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"
          integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
    <link th:href="@{/css/register.css}" rel="stylesheet">
    <title>글 상세</title>
    <style>
        .container {

        }
        .table td {
            border:1px solid;
        }
        .table th {
            border:1px solid;
        }
        .form-detail {
            background-color:transparent;
            border:none;
        }
        .form-text {
            width:100%;
            border:none;
            min-height:10rem;
        }
    </style>
</head>

<body>
<div class="py-5 text-center">
    <img class="d-block mx-auto mb-4 " src="https://getbootstrap.com/docs/4.5/assets/brand/bootstrap-solid.svg" alt="" width="72" height="72">
    <!--<h2>게시판</h2>-->
</div>
<div class="container">
    <table class="table">
        <tbody>
            <tr>
                <th scope="row"><strong class="t-15">제목</strong></th>
                <td colspan="5"><span id="boardSubject" name="boardSubject" class="form-detail" th:text="${board.title}" readonly></span></td>
            </tr>
            <tr>
                <th scope="row"><strong class="t-15">작성자</strong></th>
                <td><span type="text" id="writer" name="writer" class="form-detail" th:text="${board.name}" readonly></span></td>
                <th scope="row"><strong class="t-15">작성일</strong></th>
                <td><span type="text" id="datetime" name="datetime" class="form-detail" value="10" th:text="${board.datetime}" readonly></span></td>
                <th scope="row"><strong class="t-15">조회수</strong></th>
                <td><span type="text" id="viewCnt" name="viewCnt" class="form-detail" value="10" th:text="${board.viewCnt}" readonly></span></td>
            </tr>
            <tr>
                <th scope="row" colspan="6"><strong class="t-15">내용</strong></th>
            </tr>
            <tr>
                <th scope="row" colspan="6"><textarea type="text" id="contents" name="contents" class="form-text" th:text="${board.contents}" readonly></textarea></th>
            </tr>
        </tbody>
    </table>

    <div class="text-right">
        <button class="btn btn-primary" th:onclick="|location.href='@{/board/{user_idx}/edit(user_idx=${board.user_idx})}'|"
                th:if="${#authentication.name == board.name}">수정</button>
        <button class="btn btn-primary" th:onclick="|location.href='@{/board/{user_idx}/delete(user_idx=${board.user_idx})}'|"
                th:if="${#authentication.name == board.name}">삭제</button>
        <button class="btn btn-secondary" th:onclick="|location.href='@{/board/boards}'|">목록</button>
    </div>
</div> <!-- /container -->

<div class="container">
    <h4>댓글</h4>
    <div id="comment">
    </div>

    <form action="#" th:action="@{/board/comment/write}" method="post">
        <input type="hidden" name="boardId" th:value="${board.user_idx}">
        <div class="mb-3">
            <label for="content" class="form-label"></label>
            <textarea class="form-control" id="content" name="content" rows="4"
                      placeholder="댓글을 작성해주세요."></textarea>
        </div>
        <button type="submit" class="me-2 btn btn-primary">write</button>
    </form>
</div>

<footer th:replace="fragments/common :: footer"/>
<script th:inline="javascript">
        $(document).ready(function () {
            getComments();
        })

        function getComments() {
            var boardId = $('input[name=boardId]').val()
            console.log(boardId);

            $.ajax({
                type: 'GET',
                url: '/board/comment/getCommentList',
                data: { boardId },
                success: function (response) {
                    console.log(boardId);
                    var a = '';
                    var size = 0;
                    $.each(response, function (key, value) {
                    console.log(value);
                        size = size + 1;
                        a += '<hr /><div>'
                        a += '<input type="hidden" id="commentId" name="commentId" value="' + value.commentNumber + '">'
                        a += '<span id="writer" style="font-weight: bold;">' + value.creatorID + '</span>'
                        a += '<ul name="commentChange" class="justify-content-end" style="display: inline;">'
                                a += '<li name="commentUpdate" type="button" style="display: inline; opacity: 0.7; font-size: small; margin-right: 5px" onclick="updateCommentForm(' + value.commentNumber + ')">수정</li>'
                                a += '<li name="commentDelete" type="button" style="display: inline; opacity: 0.7; font-size: small;" onclick="deleteComment(' + value.commentNumber + ')">삭제</li></ul>'
                        a += '<pre id="' + value.commentNumber + '" name="comment' + value.commentNumber + '" style="margin-bottom: 5px; font-size: large;">' + value.commentContent + '</pre>'
                         a += '<p name="createDate' + value.commentNumber + '" style="margin-bottom: 5px; opacity: 0.5; font-size: small;">' + value.commentDate.substring(0, 10) + ' ' + value.commentDate.substring(11, 19) + '</p></div>'

                    });
                    $("#comment").html(a)
                },
                 error: function (response) {
                    console.log("error : " + response)
                },
                complete: function () { }
            })
        }
         function insertComment() {
            var boardId = $('input[name=boardId]').val()
            var content = document.getElementById("content").value
            var param = {"content": content}
            var url = '/board/comment/write'
            console.log(content);

                $.ajax({
                    contentType: 'application/json',
                    type: 'POST',
                    url: url,
                    data: JSON.stringify(param),
                    success: function (response) {
                        getComments()
                    },
                    error: function (response) {
                        console.log("insertComment error : " + response)
                    },
                })

        }
        function updateCommentForm(id) {
            var commentId = id;
            var content = document.getElementById(id).innerText;

            $('ul[name=commentChange]').hide()
            $('pre[name=comment' + commentId + ']').contents().unwrap().wrap('<textarea id="newComment" class="form-control mt-2" name="updateContent" rows="4"></textarea>');
            $('p[name=createDate' + commentId + ']').contents().unwrap().wrap('<input name="update" type="button" class="me-2 mt-2 btn btn-primary" value="수정하기" onclick="updateComment(' + commentId + ')">');
            $('input[name=update]').after("<button class=\"me-2 mt-2 btn btn-primary\" onclick=\"getComments()\">취소</button>")
        }
        function updateComment(id) {
            var commentId = id;
            var content = document.getElementById("newComment").value;

            $.ajax({
                type: 'POST',
                url: '/board/comment/update',
                data: {
                    commentId:commentId,
                    content:content

                },
                success: function (response) {
                    getComments()
                },
                error: function (response) {
                    console.log("update error : " + response)
                },
                complete: function () { }
            })
        }
        function deleteComment(id) {
            var commentId = id;
            console.log(commentId);
            if (confirm("정말 삭제하시겠습니까?")) {
                $.ajax({
                    type: 'POST',
                    url: '/board/comment/delete',
                    data: { commentId },
                    success: function (response) {
                        getComments()
                    },
                    error: function (response) {
                        console.log("delete error : " + response)
                    },
                    complete: function () { }
                })
            } else {
                return;
            }
        }
        </script>
</body>
</html>